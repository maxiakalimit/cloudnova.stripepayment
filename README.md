# Платежный модуль Stripe

Модуль позволяет начать принимать оплату через платежную систему Stripe.

### Способы оплаты

* Банковские карты (Card)
* Кредитные карты (CreditCard)
* Sepa Debit / IBAN
* Sofort
* Giropay

### Поддерживаемая версия STRIPE API

`2023-08-16`

## Инструкция

1. Проверить права у папки `/bitrix/modules/`
1. Скопировать содержимое репозитория (кроме `.git`, `.github`, `README.md`) в папку `/bitrix/modules/cloudnova.stripepayment/`
1. Перейти в административную панель Битрикс
1. Установить модуль: Настройки → Настройки продукта → Модули → "Платежная система Stripe"
1. Добавить платежную систему: Магазин → Настройки → Платежные системы → Добавить
   * В пункте "Обработчик" выбираем `stripe`
   * Название (NAME) обязательно должно быть `Stripe` или `stripe` (иначе вебхук не будет работать)
   * Заполняем API ключи из кабинета stripe.com
1. Настраиваем вебхуки:
   * Копируем `stripeWebhook.php` из корня модуля в публичную часть сайта (например в корень сайта)
   * В кабинете stripe.com добавляем вебхук:
      * URL: `https://ваш-сайт.ru/stripeWebhook.php`
      * События: `charge.succeeded`, `checkout.session.completed`
      * Версия API: `2023-08-16`
   * Копируем Webhook Signing Secret в настройки платежной системы
1. Использовать!


## Поддержка режимов:
* тестовый режим (demo mode) - по умолчанию
* боевой режим (live mode)

## Поддержка шаблонов:
* **REDIRECT** - шаблон при котором происходит сразу редирект на платежную страницу stripe.com

Куда класть свой шаблон?

_Вы можете создать свой шаблон вывода и в последующем выбрать его в настройках._

Пример шаблона CUSTOM можно скачать по ссылке: https://github.com/darkfriend/bitrix_dev2fun.stripepayment/tree/master/utf8/dev2fun.stripepayment/install/sale_payment/stripe/templates/custom

Вам нужно положить свой шаблон в одну из нижеследующих каталогов (пути от корня сайта):
* `/local/php_interface/sale_payment/stripe/templates/`
* `/bitrix/php_interface/sale_payment/stripe/templates/`

_Последовательность соблюдена._\
_Совпадения имен игнорируются._

## Поддержка событий:

* **OnBeforeStripeCharge** - вызывается после создания customer.\
**Передаются параметры:**
    * `&$arCreateFields` - массив, который дальше идет в `\Stripe\Charge::create`
    * `$customer` - объект от `\Stripe\Customer::create`
    
* **OnBeforeUpdateOrder** - вызывается после получения статуса оплаты.\
Передаются параметры:
    * `&$arFields` - массив полей, который идет в обновление заказа (`CSaleOrder::Update`)
    * `$charge` - объект от `\Stripe\Charge::create`
    * `$orderID` - идентификатор заказа
    
* **OnBeforeSuccessOutput** - вызывается перед выводом сообщения о успехе.\
Передаются параметры:
    * `&$output` - строка или HTML-код, которая выведет результат.
    * `$arFields` - массив полей от заказа (тот же, что был в `CSaleOrder::Update`)
    * `$orderID` - идентификатор заказа
    
* **OnBeforeErrorOutput** - вызывается перед выводом сообщения об ошибке.\
Передаются параметры:
    * `&$error` - строка или HTML-код, которая выведет ошибку.
    * `$errorText` - строка с сообщением ошибки
    * `$arFields` - массив полей от заказа (тот же, что был в `CSaleOrder::Update`)
    * `$orderID` - идентификатор заказа
Если есть нарекания или предложения по улучшению модуля пишите на почту техподдержки.